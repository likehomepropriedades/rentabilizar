<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Conte√∫do LikeHome</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; max-width: 800px; margin: auto; }
    input, textarea { width: 100%; margin-bottom: 10px; font-size: 1rem; padding: 0.5rem; }
    textarea { height: 80px; }
    .item { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 5px; background: #f9f9f9; }
    .btn { padding: 10px 20px; margin-top: 1rem; cursor: pointer; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    #status { margin-bottom: 1rem; font-weight: bold; color: #555; }
    #welcome { margin-bottom: 1.5rem; }
    #logout { margin-left: 10px; font-size: 0.9rem; cursor: pointer; color: blue; text-decoration: underline; background: none; border: none; }
  </style>
</head>
<body>
  <h1>Administra√ß√£o de Conte√∫do LikeHome</h1>
  <div id="welcome"></div>
  <button id="btnCarregar" class="btn" onclick="carregarCSV()">üîÑ Carregar conte√∫do</button>
  <button id="btnLogout" style="display:none;" class="btn" onclick="logout()">üö™ Logout</button>
  <div id="status"></div>
  <div id="formArea"></div>
  <button id="btnSalvar" class="btn" onclick="salvarNoGitHub()">üíæ Salvar no GitHub</button>

  <script>
    const backendURL = "https://script.google.com/macros/s/AKfycbyx8e29uo5bIWBl82s0I_o2Mz9ZPzjW-IDp0Xs1TaqRaL0NWK7SbeFtE9dRO9FZcaz9QA/exec";
    let dados = [];
    let shaAtual = "";

    const btnCarregar = document.getElementById("btnCarregar");
    const btnSalvar = document.getElementById("btnSalvar");
    const btnLogout = document.getElementById("btnLogout");
    const welcomeDiv = document.getElementById("welcome");
    const statusDiv = document.getElementById("status");
    const formArea = document.getElementById("formArea");

    async function checarUsuario() {
      statusDiv.textContent = "Verificando usu√°rio...";
      btnCarregar.disabled = true;
      btnSalvar.disabled = true;

      try {
        const res = await fetch(backendURL + "?user=true", {
          credentials: "include"
        });
        const json = await res.json();
        if (json.error) {
          welcomeDiv.innerHTML = `<h2>Acesso negado</h2><p>${json.error}</p>`;
          throw new Error("Usu√°rio n√£o autorizado");
        }
        welcomeDiv.textContent = `Bem-vindo(a), ${json.email}`;
        btnLogout.style.display = "inline-block";
        return json.email;
      } catch (e) {
        console.error(e);
        welcomeDiv.innerHTML = `<h2>Erro de autentica√ß√£o</h2><p>${e.message}</p>`;
        throw e;
      } finally {
        statusDiv.textContent = "";
        btnCarregar.disabled = false;
      }
    }

    async function carregarCSV() {
      statusDiv.textContent = "Carregando conte√∫do...";
      btnCarregar.disabled = true;
      btnSalvar.disabled = true;
      formArea.innerHTML = "";
      dados = [];
      shaAtual = "";

      try {
        await checarUsuario();

        const resposta = await fetch(backendURL, {
          credentials: "include"
        });
        const conteudo = await resposta.json();

        if (conteudo.error) {
          alert("Erro ao carregar: " + conteudo.error);
          return;
        }

        shaAtual = conteudo.sha;

        const linhas = conteudo.csv.trim().split("\n").slice(1);
        dados = linhas.map(linha => {
          // Cuidado com v√≠rgulas internas entre aspas
          const regexCSV = /("([^"]|"")*"|[^,]*)(,|$)/g;
          let matches = [];
          let m;
          while ((m = regexCSV.exec(linha)) !== null) {
            matches.push(m[1]);
            if (m.index === regexCSV.lastIndex) {
              regexCSV.lastIndex++;
            }
          }
          const chave = matches[0].replace(/^"|"$/g, "");
          const valorRaw = matches.slice(1).join(",");
          const valor = valorRaw.replace(/^"|"$/g, "").replace(/""/g, '"');

          return { chave, valor };
        });

        renderizarFormulario();
      } catch (e) {
        console.error("Erro ao carregar CSV:", e);
        alert("Erro ao carregar conte√∫do. Veja console para detalhes.");
      } finally {
        statusDiv.textContent = "";
        btnCarregar.disabled = false;
        btnSalvar.disabled = false;
      }
    }

    function renderizarFormulario() {
      formArea.innerHTML = "";

      dados.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <strong>${item.chave}</strong><br>
          <textarea onchange="atualizarValor(${index}, this.value)">${item.valor}</textarea>
        `;
        formArea.appendChild(div);
      });
    }

    function atualizarValor(index, novoValor) {
      dados[index].valor = novoValor;
    }

    async function salvarNoGitHub() {
      statusDiv.textContent = "Salvando conte√∫do...";
      btnSalvar.disabled = true;
      btnCarregar.disabled = true;

      try {
        const csvNovo = "chave,valor\n" + dados
          .map(d => `${d.chave},"${d.valor.replace(/"/g, '""')}"`)
          .join("\n");

        const resposta = await fetch(backendURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ csv: csvNovo, sha: shaAtual })
        });

        const resultado = await resposta.json();
        if (resposta.ok) {
          alert("Atualiza√ß√£o realizada com sucesso!");
          await carregarCSV();
        } else {
          alert("Erro: " + resultado.error);
        }
      } catch (e) {
        console.error("Erro ao salvar no GitHub:", e);
        alert("Erro ao salvar conte√∫do. Veja console para detalhes.");
      } finally {
        statusDiv.textContent = "";
        btnSalvar.disabled = false;
        btnCarregar.disabled = false;
      }
    }

    function logout() {
      // Redireciona para logout do Google (remova se n√£o quiser logout)
      window.location.href = "https://accounts.google.com/Logout?continue=https://likehomepropriedades.github.io/";
    }

    window.onload = carregarCSV;
  </script>
</body>
</html>
